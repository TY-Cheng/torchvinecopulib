<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.3.5 and Furo 2024.01.29 -->
        <title>torchvinecopulib.util - torchvinecopulib 2024.4.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">torchvinecopulib 2024.4.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">torchvinecopulib 2024.4.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../torchvinecopulib.vinecop.html">torchvinecopulib.vinecop package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torchvinecopulib.bicop.html">torchvinecopulib.bicop package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torchvinecopulib.util.html">torchvinecopulib.util package</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for torchvinecopulib.util</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">kendalltau</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;ENUM_FUNC_BIDEP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kendall_tau&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mutual_info&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ferreira_tail_dep_coeff&quot;</span><span class="p">,</span>
    <span class="s2">&quot;chatterjee_xi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wasserstein_dist_ind&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cdf_func_kernel&quot;</span><span class="p">,</span>
    <span class="s2">&quot;debye1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;solve_ITP&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">_CDF_MIN</span><span class="p">,</span> <span class="n">_CDF_MAX</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span>
<span class="n">_NU_MIN</span><span class="p">,</span> <span class="n">_NU_MAX</span> <span class="o">=</span> <span class="mf">1.001</span><span class="p">,</span> <span class="mf">49.999</span>
<span class="n">_RHO_MIN</span><span class="p">,</span> <span class="n">_RHO_MAX</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.99</span>
<span class="n">_TAU_MIN</span><span class="p">,</span> <span class="n">_TAU_MAX</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.999</span><span class="p">,</span> <span class="mf">0.999</span>


<span class="c1"># def kendall_tau(</span>
<span class="c1">#     x: torch.Tensor,</span>
<span class="c1">#     y: torch.Tensor,</span>
<span class="c1">#     tau_min: float = _TAU_MIN,</span>
<span class="c1">#     tau_max: float = _TAU_MAX,</span>
<span class="c1"># ) -&gt; float:</span>
<span class="c1">#     &quot;&quot;&quot;https://gist.github.com/ili3p/f2b38b898f6eab0d87ec248ea39fde94</span>
<span class="c1">#     x,y are both of shape (n, 1)</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     n = x.shape[0]</span>
<span class="c1">#     n *= n - 1</span>
<span class="c1">#     return (</span>
<span class="c1">#         ((x.T - x).sign() * (y.T - y).sign()).sum().div(n).clamp(min=tau_min, max=tau_max).item()</span>
<span class="c1">#     )</span>


<div class="viewcode-block" id="kendall_tau">
<a class="viewcode-back" href="../../torchvinecopulib.util.html#torchvinecopulib.util.kendall_tau">[docs]</a>
<span class="k">def</span> <span class="nf">kendall_tau</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">tau_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_TAU_MIN</span><span class="p">,</span>
    <span class="n">tau_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_TAU_MAX</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;https://gist.github.com/ili3p/f2b38b898f6eab0d87ec248ea39fde94</span>
<span class="sd">    x,y are both of shape (n, 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">kendalltau</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tau_max</span><span class="p">),</span> <span class="n">tau_min</span><span class="p">),</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="mutual_info">
<a class="viewcode-back" href="../../torchvinecopulib.util.html#torchvinecopulib.util.mutual_info">[docs]</a>
<span class="k">def</span> <span class="nf">mutual_info</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">is_sklearn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;https://scikit-learn.org/stable/modules/generated/sklearn.feature_selection.mutual_info_regression.html</span>
<span class="sd">    x,y are both of shape (n, 1)</span>

<span class="sd">    Purkayastha, S., &amp; Song, P. X. K. (2024).</span>
<span class="sd">    fastMI: A fast and consistent copula-based nonparametric estimator of mutual information.</span>
<span class="sd">    Journal of Multivariate Analysis, 201, 105270.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_sklearn</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">mutual_info_regression</span>

        <span class="k">return</span> <span class="n">mutual_info_regression</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
            <span class="c1"># ! notice the shape of y</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">discrete_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Purkayastha, S., &amp; Song, P. X. K. (2024).</span>
        <span class="kn">from</span> <span class="nn">fastkde.fastKDE</span> <span class="kn">import</span> <span class="n">pdf_at_points</span>
        <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">log</span>

        <span class="n">x_</span><span class="p">,</span> <span class="n">y_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">joint</span> <span class="o">=</span> <span class="n">pdf_at_points</span><span class="p">(</span><span class="n">var1</span><span class="o">=</span><span class="n">x_</span><span class="p">,</span> <span class="n">var2</span><span class="o">=</span><span class="n">y_</span><span class="p">)</span>
        <span class="n">joint</span> <span class="o">=</span> <span class="n">joint</span><span class="p">[</span><span class="n">joint</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">margin_x</span> <span class="o">=</span> <span class="n">pdf_at_points</span><span class="p">(</span><span class="n">var1</span><span class="o">=</span><span class="n">x_</span><span class="p">)</span>
        <span class="n">margin_x</span> <span class="o">=</span> <span class="n">margin_x</span><span class="p">[</span><span class="n">margin_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">margin_y</span> <span class="o">=</span> <span class="n">pdf_at_points</span><span class="p">(</span><span class="n">var1</span><span class="o">=</span><span class="n">y_</span><span class="p">)</span>
        <span class="n">margin_y</span> <span class="o">=</span> <span class="n">margin_y</span><span class="p">[</span><span class="n">margin_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">joint</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="n">margin_x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="n">margin_y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">()</span></div>



<div class="viewcode-block" id="ferreira_tail_dep_coeff">
<a class="viewcode-back" href="../../torchvinecopulib.util.html#torchvinecopulib.util.ferreira_tail_dep_coeff">[docs]</a>
<span class="k">def</span> <span class="nf">ferreira_tail_dep_coeff</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pairwise tail dependence coefficient (λ) estimator, max of rotation 0, 90, 180, 270</span>
<span class="sd">    x and y are both of shape (n, 1) inside (0, 1)</span>
<span class="sd">    symmetric for (x,y), (y,1-x), (1-x,1-y), (1-y,x), (y,x), (1-x,y), (1-y,1-x), (x,1-y)</span>
<span class="sd">    Ferreira, M.S., 2013. Nonparametric estimation of the tail-dependence coefficient;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="mi">3</span>
        <span class="o">-</span> <span class="p">(</span>
            <span class="mi">1</span>
            <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6666666666666666</span><span class="p">)</span>
            <span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span></div>



<div class="viewcode-block" id="chatterjee_xi">
<a class="viewcode-back" href="../../torchvinecopulib.util.html#torchvinecopulib.util.chatterjee_xi">[docs]</a>
<span class="k">def</span> <span class="nf">chatterjee_xi</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;revised Chatterjee&#39;s rank correlation coefficient (ξ), taken max to be symmetric</span>

<span class="sd">    Chatterjee, S., 2021. A new coefficient of correlation. Journal of the American Statistical Association, 116(536), pp.2009-2022.</span>

<span class="sd">    Lin, Z. and Han, F., 2023. On boosting the power of Chatterjee’s rank correlation. Biometrika, 110(2), pp.283-299.</span>
<span class="sd">    &quot;a large negative value of ξ has only one possible interpretation: the data does not resemble an iid sample.&quot;</span>

<span class="sd">    :param x: obs of shape (n,1)</span>
<span class="sd">    :type x: torch.Tensor</span>
<span class="sd">    :param y: obs of shape (n,1)</span>
<span class="sd">    :type y: torch.Tensor</span>
<span class="sd">    :param M: num of right nearest neighbors</span>
<span class="sd">    :type M: int</span>
<span class="sd">    :return: revised Chatterjee&#39;s rank correlation coefficient (ξ), taken max to be symmetric for (X,Y) and (Y,X)</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ranks of x in the order of (ranks of y)</span>
    <span class="c1"># ranks of y in the order of (ranks of x)</span>
    <span class="n">xrank</span><span class="p">,</span> <span class="n">yrank</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">x</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">y</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">xrank</span><span class="p">,</span> <span class="n">yrank</span> <span class="o">=</span> <span class="n">xrank</span><span class="p">[</span><span class="n">yrank</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)],</span> <span class="n">yrank</span><span class="p">[</span><span class="n">xrank</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>

    <span class="c1"># the inner sum inside the numerator term, ∑min(Ri, Rjm(i))</span>
    <span class="c1"># max for symmetry as following Remark 1 in Chatterjee (2021)</span>
    <span class="k">def</span> <span class="nf">xy_sum</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xrank</span><span class="p">[:</span><span class="o">-</span><span class="n">m</span><span class="p">],</span> <span class="n">xrank</span><span class="p">[</span><span class="n">m</span><span class="p">:]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">xrank</span><span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yrank</span><span class="p">[:</span><span class="o">-</span><span class="n">m</span><span class="p">],</span> <span class="n">yrank</span><span class="p">[</span><span class="n">m</span><span class="p">:]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">yrank</span><span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="c1"># whole eq. 3 in Lin and Han (2023)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">+</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">([</span><span class="n">xy_sum</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">M</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span></div>



<div class="viewcode-block" id="wasserstein_dist_ind">
<a class="viewcode-back" href="../../torchvinecopulib.util.html#torchvinecopulib.util.wasserstein_dist_ind">[docs]</a>
<span class="k">def</span> <span class="nf">wasserstein_dist_ind</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">reg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">p</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">num_sim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wasserstein distance from bicop obs to indep bicop simulations, by ot.sinkhorn2 (averaged for each observation).</span>

<span class="sd">    :param x: copula obs of shape (n,1)</span>
<span class="sd">    :type x: torch.Tensor</span>
<span class="sd">    :param y: copula obs of shape (n,1)</span>
<span class="sd">    :type y: torch.Tensor</span>
<span class="sd">    :param reg: regularization strength, defaults to 0.1</span>
<span class="sd">    :type reg: float, optional</span>
<span class="sd">    :param p: p-norm distance to calculate between each vector pair, defaults to 2</span>
<span class="sd">    :type p: int, optional</span>
<span class="sd">    :param seed: random seed for torch.manual_seed() in indep bicop simulations, defaults to 0</span>
<span class="sd">    :type seed: int, optional</span>
<span class="sd">    :return: Wasserstein distance from bicop obs to indep bicop simulations</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ot</span> <span class="kn">import</span> <span class="n">sinkhorn2</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">X_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
    <span class="n">num_obs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_obs</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_obs</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_obs</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_obs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">sum</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">sinkhorn2</span><span class="p">(</span>
                    <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
                    <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span>
                    <span class="n">M</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">X_s</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">X_s</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">),</span>
                    <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">/</span> <span class="n">num_sim</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="ENUM_FUNC_BIDEP">
<a class="viewcode-back" href="../../torchvinecopulib.util.html#torchvinecopulib.util.ENUM_FUNC_BIDEP">[docs]</a>
<span class="k">class</span> <span class="nc">ENUM_FUNC_BIDEP</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;an enum class for bivariate dependence measures&quot;&quot;&quot;</span>

    <span class="n">chatterjee_xi</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">chatterjee_xi</span><span class="p">)</span>
    <span class="n">ferreira_tail_dep_coeff</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ferreira_tail_dep_coeff</span><span class="p">)</span>
    <span class="n">kendall_tau</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">kendall_tau</span><span class="p">)</span>
    <span class="n">mutual_info</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">mutual_info</span><span class="p">)</span>
    <span class="n">wasserstein_dist_ind</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">wasserstein_dist_ind</span><span class="p">)</span></div>



<div class="viewcode-block" id="cdf_func_kernel">
<a class="viewcode-back" href="../../torchvinecopulib.util.html#torchvinecopulib.util.cdf_func_kernel">[docs]</a>
<span class="k">def</span> <span class="nf">cdf_func_kernel</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">is_scott</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;kernel density estimation (KDE) function of the cumulative distribution function (CDF)</span>

<span class="sd">    :param obs: observations, of shape (n,1)</span>
<span class="sd">    :type obs: torch.Tensor</span>
<span class="sd">    :param is_scott: whether to use Scott&#39;s rule for bandwidth, defaults to True</span>
<span class="sd">    :type is_scott: bool, optional</span>
<span class="sd">    :return: a CDF function by KDE</span>
<span class="sd">    :rtype: callable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_scott</span><span class="p">:</span>
        <span class="c1"># * bandwidth by Scott 1992</span>
        <span class="n">band_width</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mf">1.349</span>
        <span class="n">band_width</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">clamp_max</span><span class="p">(</span><span class="n">band_width</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.059</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">band_width</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.6973425390765554</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.1111111111111111</span>

    <span class="k">def</span> <span class="nf">func_cdf</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ndtr</span><span class="p">((</span><span class="n">q</span> <span class="o">-</span> <span class="n">obs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">band_width</span><span class="p">)</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">func_cdf</span></div>



<span class="c1"># * Gaussian distribution CDF (p), PPF (q), density (d)</span>
<span class="n">pnorm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ndtr</span>
<span class="n">qnorm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ndtri</span>


<span class="k">def</span> <span class="nf">pbvnorm</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CDF of (standard) bivariate Gaussian distribution</span>
<span class="sd">    modified from http://www.math.wsu.edu/faculty/genz/software/matlab/bvnl.m</span>
<span class="sd">    https://keisan.casio.com/exec/system/1280624821</span>

<span class="sd">    :param obs: bivariate Gaussian observations, of shape (num_obs, 2)</span>
<span class="sd">    :type obs: torch.Tensor</span>
<span class="sd">    :param rho: the rho parameter, also a Pearson&#39;s corr coef</span>
<span class="sd">    :type rho: float</span>
<span class="sd">    :return: cumulative distribution function (CDF) of shape (num_obs, 1), given the observation</span>
<span class="sd">    :rtype: torch.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">_RHO_MIN</span><span class="p">),</span> <span class="n">_RHO_MAX</span><span class="p">)</span>
    <span class="c1"># Gauss Legendre points and weights, n = 100</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">(</span>
            <span class="mf">0.007968192496166605</span><span class="p">,</span>
            <span class="mf">0.01846646831109096</span><span class="p">,</span>
            <span class="mf">0.02878470788332337</span><span class="p">,</span>
            <span class="mf">0.03879919256962705</span><span class="p">,</span>
            <span class="mf">0.04840267283059405</span><span class="p">,</span>
            <span class="mf">0.057493156217619065</span><span class="p">,</span>
            <span class="mf">0.06597422988218049</span><span class="p">,</span>
            <span class="mf">0.0737559747377052</span><span class="p">,</span>
            <span class="mf">0.08075589522942021</span><span class="p">,</span>
            <span class="mf">0.08689978720108298</span><span class="p">,</span>
            <span class="mf">0.09212252223778612</span><span class="p">,</span>
            <span class="mf">0.09636873717464425</span><span class="p">,</span>
            <span class="mf">0.09959342058679527</span><span class="p">,</span>
            <span class="mf">0.1017623897484055</span><span class="p">,</span>
            <span class="mf">0.10285265289355884</span><span class="p">,</span>
            <span class="mf">0.007968192496166605</span><span class="p">,</span>
            <span class="mf">0.01846646831109096</span><span class="p">,</span>
            <span class="mf">0.02878470788332337</span><span class="p">,</span>
            <span class="mf">0.03879919256962705</span><span class="p">,</span>
            <span class="mf">0.04840267283059405</span><span class="p">,</span>
            <span class="mf">0.057493156217619065</span><span class="p">,</span>
            <span class="mf">0.06597422988218049</span><span class="p">,</span>
            <span class="mf">0.0737559747377052</span><span class="p">,</span>
            <span class="mf">0.08075589522942021</span><span class="p">,</span>
            <span class="mf">0.08689978720108298</span><span class="p">,</span>
            <span class="mf">0.09212252223778612</span><span class="p">,</span>
            <span class="mf">0.09636873717464425</span><span class="p">,</span>
            <span class="mf">0.09959342058679527</span><span class="p">,</span>
            <span class="mf">0.1017623897484055</span><span class="p">,</span>
            <span class="mf">0.10285265289355884</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">device</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">(</span>
            <span class="mf">0.003106515925350495</span><span class="p">,</span>
            <span class="mf">0.016331876720252825</span><span class="p">,</span>
            <span class="mf">0.03997813503169245</span><span class="p">,</span>
            <span class="mf">0.07379995257072569</span><span class="p">,</span>
            <span class="mf">0.11743946420794726</span><span class="p">,</span>
            <span class="mf">0.17043423761723164</span><span class="p">,</span>
            <span class="mf">0.23222256789517381</span><span class="p">,</span>
            <span class="mf">0.30214950520668415</span><span class="p">,</span>
            <span class="mf">0.3794738170107571</span><span class="p">,</span>
            <span class="mf">0.46337585185798014</span><span class="p">,</span>
            <span class="mf">0.5529662304619108</span><span class="p">,</span>
            <span class="mf">0.6472952744691218</span><span class="p">,</span>
            <span class="mf">0.7453630738321102</span><span class="p">,</span>
            <span class="mf">0.8461300863914165</span><span class="p">,</span>
            <span class="mf">0.9485281574446823</span><span class="p">,</span>
            <span class="mf">1.9968934840746495</span><span class="p">,</span>
            <span class="mf">1.983668123279747</span><span class="p">,</span>
            <span class="mf">1.9600218649683074</span><span class="p">,</span>
            <span class="mf">1.9262000474292744</span><span class="p">,</span>
            <span class="mf">1.8825605357920527</span><span class="p">,</span>
            <span class="mf">1.8295657623827684</span><span class="p">,</span>
            <span class="mf">1.7677774321048263</span><span class="p">,</span>
            <span class="mf">1.697850494793316</span><span class="p">,</span>
            <span class="mf">1.6205261829892428</span><span class="p">,</span>
            <span class="mf">1.5366241481420198</span><span class="p">,</span>
            <span class="mf">1.447033769538089</span><span class="p">,</span>
            <span class="mf">1.3527047255308782</span><span class="p">,</span>
            <span class="mf">1.2546369261678898</span><span class="p">,</span>
            <span class="mf">1.1538699136085835</span><span class="p">,</span>
            <span class="mf">1.0514718425553178</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">device</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">obs</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">asr</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">sn</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">asr</span><span class="p">)</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">square</span><span class="p">())</span> <span class="o">/</span> <span class="o">-</span><span class="mf">2.0</span>
                    <span class="c1"># ! broadcast: x,sn are rows; w,h,k are columns</span>
                    <span class="o">+</span> <span class="n">sn</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="n">k</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sn</span><span class="o">.</span><span class="n">square</span><span class="p">())</span>
            <span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
            <span class="o">@</span> <span class="n">w</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">asr</span> <span class="o">/</span> <span class="mf">6.283185307179586</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">pnorm</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">pnorm</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">nan_to_num</span><span class="p">()</span>
        <span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">_CDF_MIN</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">_CDF_MAX</span><span class="p">)</span>
    <span class="p">)</span>


<span class="c1"># # * Student&#39;s t distribution CDF (p), PPF (q), density (d)</span>
<span class="c1"># def inc_beta_reg(vec: torch.Tensor, a: float, b: float) -&gt; torch.Tensor:</span>
<span class="c1">#     # * regularized incomplete beta integral, with a = 0.5, b = nu / 2, vec in [0,1]</span>
<span class="c1">#     # https://stats.stackexchange.com/questions/615961/students-t-cdf-ppf-or-hypergeometric-2f1-or-betainc-using-pytorch</span>
<span class="c1">#     # https://stats.stackexchange.com/questions/52341/formula-to-generate-critical-t-values-for-t-test-instead-of-using-a-look-up-arr</span>
<span class="c1">#     res = torch.empty_like(vec)</span>
<span class="c1">#     if (idx := vec &gt; ((a + 1.0) / (2.0 + a + b))).any():</span>
<span class="c1">#         res[idx] = 1.0 - inc_beta_reg(vec=1.0 - vec[idx], a=b, b=a)</span>
<span class="c1">#     idx = ~idx</span>
<span class="c1">#     x = vec[idx]</span>
<span class="c1">#     qab = a + b</span>
<span class="c1">#     qap = a + 1.0</span>
<span class="c1">#     qam = a - 1.0</span>
<span class="c1">#     c = torch.ones_like(x)</span>
<span class="c1">#     d = 1.0 / (1.0 - qab * x / qap)</span>
<span class="c1">#     f = d.clone()</span>
<span class="c1">#     front = (</span>
<span class="c1">#         -math.lgamma(a)</span>
<span class="c1">#         - math.lgamma(b)</span>
<span class="c1">#         + math.lgamma(a + b)</span>
<span class="c1">#         - math.log(a)</span>
<span class="c1">#         + x.log() * a</span>
<span class="c1">#         + x.neg().log1p() * b</span>
<span class="c1">#     ).exp()</span>
<span class="c1">#     for i in range(1, 200):</span>
<span class="c1">#         i2 = i * 2.0</span>
<span class="c1">#         ai2 = a + i2</span>
<span class="c1">#         nmrt = (i * (b - i) / ((qam + i2) * ai2)) * x</span>
<span class="c1">#         d = (d * nmrt + 1.0).reciprocal()</span>
<span class="c1">#         c = nmrt / c + 1.0</span>
<span class="c1">#         f *= c * d</span>
<span class="c1">#         nmrt = (-(a + i) * (qab + i) / ((qap + i2) * ai2)) * x</span>
<span class="c1">#         d = (d * nmrt + 1.0).reciprocal()</span>
<span class="c1">#         c = nmrt / c + 1.0</span>
<span class="c1">#         cd = c * d</span>
<span class="c1">#         f *= cd</span>
<span class="c1">#         if ((1.0 - cd).abs() &lt; 1e-6).all():</span>
<span class="c1">#             break</span>
<span class="c1">#     res[idx] = front * f</span>
<span class="c1">#     return res.nan_to_num().clamp(min=_CDF_MIN, max=_CDF_MAX)</span>


<span class="c1"># def inc_beta_reg_inv(vec: torch.Tensor, a: float, b: float) -&gt; torch.Tensor:</span>
<span class="c1">#     a1, b1 = a - 1.0, b - 1.0</span>
<span class="c1">#     if a &gt; 1.0 and b &gt; 1.0:</span>
<span class="c1">#         tmp = vec.clone()</span>
<span class="c1">#         idx = vec &gt;= 0.5</span>
<span class="c1">#         tmp[idx] = 1.0 - tmp[idx]</span>
<span class="c1">#         t = (-2.0 * tmp.log()).sqrt()</span>
<span class="c1">#         x = (2.30753 + t * 0.27061) / (1.0 + t * (0.99229 + t * 0.04481)) - t</span>
<span class="c1">#         idx = ~idx</span>
<span class="c1">#         x[idx] = -x[idx]</span>
<span class="c1">#         al = (x.square() - 3.0) / 6.0</span>
<span class="c1">#         h = 2.0 / (1.0 / (2.0 * a - 1.0) + 1.0 / (2.0 * b - 1.0))</span>
<span class="c1">#         w = (x * math.sqrt(al + h) / h) - (1.0 / (2.0 * b - 1.0) - 1.0 / (2.0 * a - 1.0)) * (</span>
<span class="c1">#             al + 5.0 / 6.0 - 2.0 / (3.0 * h)</span>
<span class="c1">#         )</span>
<span class="c1">#         x = a / (a + b * (2.0 * w).exp())</span>
<span class="c1">#     else:</span>
<span class="c1">#         x = vec.clone()</span>
<span class="c1">#         t = math.exp(a * math.log(a / (a + b))) / a</span>
<span class="c1">#         w = t + math.exp(b * math.log(b / (a + b))) / b</span>
<span class="c1">#         idx = vec &lt; t / w</span>
<span class="c1">#         x[idx] = (a * w * x[idx]).pow(1.0 / a)</span>
<span class="c1">#         idx = ~idx</span>
<span class="c1">#         x[idx] = 1.0 - (b * w * (1.0 - x[idx])).pow(1.0 / b)</span>
<span class="c1">#     afac = math.lgamma(a + b) - math.lgamma(a) - math.lgamma(b)</span>
<span class="c1">#     for _ in range(10):</span>
<span class="c1">#         t = (a1 * x.log() + b1 * x.neg().log1p() + afac).exp()</span>
<span class="c1">#         u = (inc_beta_reg(vec=x, a=a, b=b) - vec) / t</span>
<span class="c1">#         t = u / (1.0 - 0.5 * (u * (a1 / x - b1 / (1.0 - x))).clamp_max(max=1.0))</span>
<span class="c1">#         idx = (x &gt; 0.0) &amp; (x &lt; 1.0)</span>
<span class="c1">#         x[idx] -= t[idx]</span>
<span class="c1">#         idx = x &lt; 0.0</span>
<span class="c1">#         x[idx] = 0.5 * (x[idx] + t[idx])</span>
<span class="c1">#         idx = x &gt; 1.0</span>
<span class="c1">#         x[idx] = 0.5 * (x[idx] + t[idx] + 1.0)</span>
<span class="c1">#         x = x.nan_to_num().clamp(min=_CDF_MIN, max=_CDF_MAX)</span>
<span class="c1">#     return x</span>


<span class="c1"># def pt(vec: torch.Tensor, nu: float) -&gt; torch.Tensor:</span>
<span class="c1">#     if nu == 1:</span>
<span class="c1">#         res = vec.atan() / 3.141592653589793 + 0.5</span>
<span class="c1">#     elif nu == 2:</span>
<span class="c1">#         res = (vec / (vec.square() + 2.0).sqrt() + 1.0) / 2.0</span>
<span class="c1">#     elif nu == 3:</span>
<span class="c1">#         res = (</span>
<span class="c1">#             (vec / 1.7320508075688772).atan() / 3.141592653589793</span>
<span class="c1">#             + 0.5</span>
<span class="c1">#             + 0.5513288954217921 * vec / (vec.square() + 3.0)</span>
<span class="c1">#         )</span>
<span class="c1">#     elif nu == 4:</span>
<span class="c1">#         _ = vec.square()</span>
<span class="c1">#         res = (vec * (_ + 6.0) / (_ + 4.0).pow(1.5) + 1.0) / 2.0</span>
<span class="c1">#     elif nu == 5:</span>
<span class="c1">#         res = (</span>
<span class="c1">#             (vec / 2.23606797749979).atan() / 3.141592653589793</span>
<span class="c1">#             + (</span>
<span class="c1">#                 (vec.square() * 3.0 + 25.0)</span>
<span class="c1">#                 * 0.23725418113905902</span>
<span class="c1">#                 * vec</span>
<span class="c1">#                 / (vec.square() + 5.0).square()</span>
<span class="c1">#             )</span>
<span class="c1">#             + 0.5</span>
<span class="c1">#         )</span>

<span class="c1">#     elif nu == 6:</span>
<span class="c1">#         res = vec.square()</span>
<span class="c1">#         res = ((res.square() * 2.0 + res * 30.0 + 135.0) * vec / (res + 6.0).pow(2.5)) / 4.0 + 0.5</span>

<span class="c1">#     else:</span>
<span class="c1">#         nu = max(min(_NU_MAX, nu), _NU_MIN)</span>
<span class="c1">#         res = inc_beta_reg(vec=nu / (vec.square() + nu), a=nu / 2.0, b=0.5)</span>
<span class="c1">#         idx = vec &gt; 0.0</span>
<span class="c1">#         res[idx] = 2.0 - res[idx]</span>
<span class="c1">#         res *= 0.5</span>
<span class="c1">#     return res.nan_to_num().clamp(min=_CDF_MIN, max=_CDF_MAX)</span>


<span class="c1"># def qt(vec: torch.Tensor, nu: float) -&gt; torch.Tensor:</span>
<span class="c1">#     vec2 = vec * 2.0</span>
<span class="c1">#     nu2 = nu / 2.0</span>
<span class="c1">#     res = torch.empty_like(input=vec, device=vec.device)</span>
<span class="c1">#     idx = vec &lt; 0.5</span>
<span class="c1">#     res[idx] = (inc_beta_reg_inv(vec=vec2[idx], a=nu2, b=0.5).reciprocal() - 1.0).sqrt().neg()</span>
<span class="c1">#     idx = ~idx</span>
<span class="c1">#     res[idx] = (inc_beta_reg_inv(vec=2.0 - vec2[idx], a=nu2, b=0.5).reciprocal() - 1.0).sqrt()</span>
<span class="c1">#     res[vec == 0.5] = 0.0</span>
<span class="c1">#     res *= math.sqrt(nu)</span>
<span class="c1">#     return res.nan_to_num()</span>


<span class="k">def</span> <span class="nf">pt_scipy</span><span class="p">(</span><span class="n">vec</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">nu</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">vec</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">vec</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">))</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">qt_scipy</span><span class="p">(</span><span class="n">vec</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">nu</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">vec</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">vec</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">))</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>


<span class="n">pt</span> <span class="o">=</span> <span class="n">pt_scipy</span>
<span class="n">qt</span> <span class="o">=</span> <span class="n">qt_scipy</span>


<span class="k">def</span> <span class="nf">l_dt</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">nu</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;log density of Student&#39;s t distribution</span>

<span class="sd">    :param obs: Student&#39;s t observations</span>
<span class="sd">    :type obs: torch.Tensor</span>
<span class="sd">    :param nu: degrees of freedom</span>
<span class="sd">    :type nu: float</span>
<span class="sd">    :return: log density, given the observations</span>
<span class="sd">    :rtype: torch.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nu2</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">obs</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="n">nu</span><span class="p">)</span><span class="o">.</span><span class="n">log1p</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">nu2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">nu2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">nu2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5723649429247001</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">pbvt</span><span class="p">(</span>
    <span class="n">obs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">nu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CDF of (standard) bivariate Student&#39;s t distribution</span>
<span class="sd">    modified from http://www.math.wsu.edu/faculty/genz/software/matlab/bvtl.m</span>

<span class="sd">    :param obs: bivariate Student&#39;s t observations, of shape (num_obs, 2)</span>
<span class="sd">    :type obs: torch.Tensor</span>
<span class="sd">    :param rho: the rho parameter</span>
<span class="sd">    :type rho: float</span>
<span class="sd">    :param nu: the nu parameter, degrees of freedom</span>
<span class="sd">    :type nu: float</span>
<span class="sd">    :return: cumulative distribution function (CDF) of shape (num_obs, 1), given the observations</span>
<span class="sd">    :rtype: torch.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">rho</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
        <span class="nb">min</span><span class="o">=</span><span class="n">_RHO_MIN</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">_RHO_MAX</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">nu</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
        <span class="nb">min</span><span class="o">=</span><span class="n">_NU_MIN</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">_NU_MAX</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">nu</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">bvt</span> <span class="o">=</span> <span class="n">pbvnorm</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xnhk</span><span class="p">,</span> <span class="n">xnkh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">ors</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">rho</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">snu</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">hhh</span><span class="p">,</span> <span class="n">kkk</span> <span class="o">=</span> <span class="n">h</span> <span class="o">-</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">h</span>
        <span class="n">hs</span><span class="p">,</span> <span class="n">ks</span> <span class="o">=</span> <span class="n">hhh</span><span class="o">.</span><span class="n">sign</span><span class="p">(),</span> <span class="n">kkk</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">hhh</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">ors</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
        <span class="n">xnhk</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hhh</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">hhh</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">+</span> <span class="n">ors</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">square</span><span class="p">()))</span>
        <span class="n">xnkh</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">kkk</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">kkk</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">+</span> <span class="n">ors</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">square</span><span class="p">()))</span>
        <span class="c1"># gmph as hhh, gmpk as kkk</span>
        <span class="k">if</span> <span class="n">nu</span><span class="o">.</span><span class="n">ceil</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bvt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">ors</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(),</span> <span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.283185307179586</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">hhh</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="mf">16.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">+</span> <span class="n">nu</span><span class="p">))</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="n">kkk</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="p">(</span><span class="mf">16.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">+</span> <span class="n">nu</span><span class="p">))</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="n">btnchk</span> <span class="o">=</span> <span class="mf">0.6366197723675814</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">xnhk</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(),</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">xnhk</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span>
            <span class="n">btpdhk</span> <span class="o">=</span> <span class="mf">0.6366197723675814</span> <span class="o">*</span> <span class="p">(</span><span class="n">xnhk</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">xnhk</span><span class="p">))</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="n">btnckh</span> <span class="o">=</span> <span class="mf">0.6366197723675814</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">xnkh</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(),</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">xnkh</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span>
            <span class="n">btpdkh</span> <span class="o">=</span> <span class="mf">0.6366197723675814</span> <span class="o">*</span> <span class="p">(</span><span class="n">xnkh</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">xnkh</span><span class="p">))</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">nu</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">bvt</span> <span class="o">+=</span> <span class="n">hhh</span> <span class="o">*</span> <span class="p">(</span><span class="n">btnckh</span> <span class="o">*</span> <span class="n">ks</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kkk</span> <span class="o">*</span> <span class="p">(</span><span class="n">btnchk</span> <span class="o">*</span> <span class="n">hs</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">hhh</span> <span class="o">*=</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">h</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="n">nu</span><span class="p">))</span>
                <span class="n">kkk</span> <span class="o">*=</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="n">nu</span><span class="p">))</span>
                <span class="n">btnchk</span> <span class="o">+=</span> <span class="n">btpdhk</span>
                <span class="n">btpdhk</span> <span class="o">*=</span> <span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">xnhk</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">btnckh</span> <span class="o">+=</span> <span class="n">btpdkh</span>
                <span class="n">btpdkh</span> <span class="o">*=</span> <span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">xnkh</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qhrk</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">ors</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="n">hkrn</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">nu</span>
            <span class="n">hkn</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">k</span> <span class="o">-</span> <span class="n">nu</span>
            <span class="n">bvt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">snu</span> <span class="o">*</span> <span class="p">(</span><span class="n">hkn</span> <span class="o">*</span> <span class="n">qhrk</span> <span class="o">+</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">hkrn</span><span class="p">),</span>
                    <span class="n">hkn</span> <span class="o">*</span> <span class="n">hkrn</span> <span class="o">-</span> <span class="n">nu</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">qhrk</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="mf">6.283185307179586</span>
            <span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">bvt</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-8</span>
            <span class="n">bvt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span>
            <span class="n">hhh</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.283185307179586</span> <span class="o">*</span> <span class="n">snu</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">h</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="n">nu</span><span class="p">))</span>
            <span class="n">kkk</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.283185307179586</span> <span class="o">*</span> <span class="n">snu</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="n">nu</span><span class="p">))</span>
            <span class="n">btnchk</span><span class="p">,</span> <span class="n">btnckh</span> <span class="o">=</span> <span class="n">xnhk</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(),</span> <span class="n">xnkh</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="n">btpdhk</span><span class="p">,</span> <span class="n">btpdkh</span> <span class="o">=</span> <span class="n">btnchk</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">btnckh</span> <span class="o">*</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="p">(</span><span class="n">nu</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">bvt</span> <span class="o">+=</span> <span class="n">hhh</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ks</span> <span class="o">*</span> <span class="n">btnckh</span><span class="p">)</span> <span class="o">+</span> <span class="n">kkk</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">hs</span> <span class="o">*</span> <span class="n">btnchk</span><span class="p">)</span>
                    <span class="n">hhh</span> <span class="o">*=</span> <span class="n">j</span> <span class="o">/</span> <span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">h</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="n">nu</span><span class="p">))</span>
                    <span class="n">kkk</span> <span class="o">*=</span> <span class="n">j</span> <span class="o">/</span> <span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="n">nu</span><span class="p">))</span>
                    <span class="n">btpdhk</span> <span class="o">*=</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">xnhk</span><span class="p">)</span> <span class="o">/</span> <span class="n">j</span>
                    <span class="n">btnchk</span> <span class="o">+=</span> <span class="n">btpdhk</span>
                    <span class="n">btpdkh</span> <span class="o">*=</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">xnkh</span><span class="p">)</span> <span class="o">/</span> <span class="n">j</span>
                    <span class="n">btnckh</span> <span class="o">+=</span> <span class="n">btpdkh</span>
    <span class="k">return</span> <span class="n">bvt</span>


<div class="viewcode-block" id="debye1">
<a class="viewcode-back" href="../../torchvinecopulib.util.html#torchvinecopulib.util.debye1">[docs]</a>
<span class="k">def</span> <span class="nf">debye1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;computes the Debye function of order 1.</span>

<span class="sd">    https://github.com/openturns/openturns/blob/b5797d7e4a71c71faf86df51f26ad0d8d551ad08/lib/src/Base/Func/SpecFunc/Debye.cxx</span>

<span class="sd">    :param x: upper limit of the integral</span>
<span class="sd">    :type x: float</span>
<span class="sd">    :return: Debye function of order 1; 0 if x&lt;=0</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># ! scalar loop faster than short np.array</span>
        <span class="n">k_max</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">][</span><span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">13</span><span class="p">),</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mf">1.64493406684822643647241516665</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">k_max</span><span class="p">):</span>
            <span class="n">xk</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">k</span>
            <span class="n">res</span> <span class="o">-=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xk</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">xk</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">xk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">res</span> <span class="o">/=</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">koeff</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">0.0</span><span class="p">,</span>
            <span class="mf">1.289868133696452872944830333292</span><span class="p">,</span>
            <span class="mf">1.646464674222763830320073930823e-01</span><span class="p">,</span>
            <span class="mf">3.468612396889827942903585958184e-02</span><span class="p">,</span>
            <span class="mf">8.154712395888678757370477017305e-03</span><span class="p">,</span>
            <span class="mf">1.989150255636170674291917800638e-03</span><span class="p">,</span>
            <span class="mf">4.921731066160965972759960954793e-04</span><span class="p">,</span>
            <span class="mf">1.224962701174096585170902102707e-04</span><span class="p">,</span>
            <span class="mf">3.056451881730374346514297527344e-05</span><span class="p">,</span>
            <span class="mf">7.634586529999679712923289243879e-06</span><span class="p">,</span>
            <span class="mf">1.907924067745592226304077366899e-06</span><span class="p">,</span>
            <span class="mf">4.769010054554659800072963735060e-07</span><span class="p">,</span>
            <span class="mf">1.192163781025189592248804158716e-07</span><span class="p">,</span>
            <span class="mf">2.980310965673008246931701326140e-08</span><span class="p">,</span>
            <span class="mf">7.450668049576914109638408036805e-09</span><span class="p">,</span>
            <span class="mf">1.862654864839336365743529470042e-09</span><span class="p">,</span>
            <span class="mf">4.656623667353010984002911951881e-10</span><span class="p">,</span>
            <span class="mf">1.164154417580540177848737197821e-10</span><span class="p">,</span>
            <span class="mf">2.910384378208396847185926449064e-11</span><span class="p">,</span>
            <span class="mf">7.275959094757302380474472711747e-12</span><span class="p">,</span>
            <span class="mf">1.818989568052777856506623677390e-12</span><span class="p">,</span>
            <span class="mf">4.547473691649305030453643155957e-13</span><span class="p">,</span>
            <span class="mf">1.136868397525517121855436593505e-13</span><span class="p">,</span>
            <span class="mf">2.842170965606321353966861428348e-14</span><span class="p">,</span>
            <span class="mf">7.105427382674227346596939068119e-15</span><span class="p">,</span>
            <span class="mf">1.776356842186163180619218277278e-15</span><span class="p">,</span>
            <span class="mf">4.440892101596083967998640188409e-16</span><span class="p">,</span>
            <span class="mf">1.110223024969096248744747318102e-16</span><span class="p">,</span>
            <span class="mf">2.775557561945046552567818981300e-17</span><span class="p">,</span>
            <span class="mf">6.938893904331845249488542992219e-18</span><span class="p">,</span>
            <span class="mf">1.734723476023986745668411013469e-18</span><span class="p">,</span>
            <span class="mf">4.336808689994439570027820336642e-19</span><span class="p">,</span>
            <span class="mf">1.084202172491329082183740080878e-19</span><span class="p">,</span>
            <span class="mf">2.710505431220232916297046799365e-20</span><span class="p">,</span>
            <span class="mf">6.776263578041593636171406200902e-21</span><span class="p">,</span>
            <span class="mf">1.694065894509399669649398521836e-21</span><span class="p">,</span>
            <span class="mf">4.235164736272389463688418879636e-22</span><span class="p">,</span>
            <span class="mf">1.058791184067974064762782460584e-22</span><span class="p">,</span>
            <span class="mf">2.646977960169798160618902050189e-23</span><span class="p">,</span>
            <span class="mf">6.617444900424343177893912768629e-24</span><span class="p">,</span>
            <span class="mf">1.654361225106068880734221123349e-24</span><span class="p">,</span>
            <span class="mf">4.135903062765153408791935838694e-25</span><span class="p">,</span>
            <span class="mf">1.033975765691286264082026643327e-25</span><span class="p">,</span>
            <span class="mf">2.584939414228213340076225223666e-26</span><span class="p">,</span>
            <span class="mf">6.462348535570530772269628236053e-27</span><span class="p">,</span>
            <span class="mf">1.615587133892632406631747637268e-27</span><span class="p">,</span>
            <span class="mf">4.038967834731580698317525293132e-28</span><span class="p">,</span>
            <span class="mf">1.009741958682895139216954234507e-28</span><span class="p">,</span>
            <span class="mf">2.524354896707237808750799932127e-29</span><span class="p">,</span>
            <span class="mf">6.310887241768094478219682436680e-30</span><span class="p">,</span>
            <span class="mf">1.577721810442023614704107565240e-30</span><span class="p">,</span>
            <span class="mf">3.944304526105059031370476640000e-31</span><span class="p">,</span>
            <span class="mf">9.860761315262647572437533499000e-32</span><span class="p">,</span>
            <span class="mf">2.465190328815661892443976898000e-32</span><span class="p">,</span>
            <span class="mf">6.162975822039154730370601500000e-33</span><span class="p">,</span>
            <span class="mf">1.540743955509788682510501190000e-33</span><span class="p">,</span>
            <span class="mf">3.851859888774471706184973900000e-34</span><span class="p">,</span>
            <span class="mf">9.629649721936179265360991000000e-35</span><span class="p">,</span>
            <span class="mf">2.407412430484044816328953000000e-35</span><span class="p">,</span>
            <span class="mf">6.018531076210112040809600000000e-36</span><span class="p">,</span>
            <span class="mf">1.504632769052528010200750000000e-36</span><span class="p">,</span>
            <span class="mf">3.761581922631320025497600000000e-37</span><span class="p">,</span>
            <span class="mf">9.403954806578300063715000000000e-38</span><span class="p">,</span>
            <span class="mf">2.350988701644575015901000000000e-38</span><span class="p">,</span>
            <span class="mf">5.877471754111437539470000000000e-39</span><span class="p">,</span>
            <span class="mf">1.469367938527859384580000000000e-39</span><span class="p">,</span>
            <span class="mf">3.673419846319648458500000000000e-40</span><span class="p">,</span>
            <span class="mf">9.183549615799121117000000000000e-41</span><span class="p">,</span>
            <span class="mf">2.295887403949780249000000000000e-41</span><span class="p">,</span>
            <span class="mf">5.739718509874450320000000000000e-42</span><span class="p">,</span>
            <span class="mf">1.434929627468612270000000000000e-42</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">x2pi</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">0.159154943091895335768883763373</span>  <span class="c1"># 1/(2pi)</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">69</span><span class="p">:</span>
            <span class="n">res_0</span> <span class="o">=</span> <span class="n">res</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">koeff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">x2pi</span> <span class="o">**</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">res</span> <span class="o">-=</span> <span class="p">(</span><span class="n">koeff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">x2pi</span> <span class="o">**</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">res</span> <span class="o">-</span> <span class="n">res_0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-7</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">4.0</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="solve_ITP">
<a class="viewcode-back" href="../../torchvinecopulib.util.html#torchvinecopulib.util.solve_ITP">[docs]</a>
<span class="k">def</span> <span class="nf">solve_ITP</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eps_2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">,</span>
    <span class="n">n_0</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">k_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">k_2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">j_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve an arbitrary function for a zero-crossing.</span>

<span class="sd">    Oliveira, I.F. and Takahashi, R.H., 2020. An enhancement of the bisection method average performance preserving minmax optimality. ACM Transactions on Mathematical Software (TOMS), 47(1), pp.1-24.</span>

<span class="sd">    https://docs.rs/kurbo/0.8.1/kurbo/common/fn.solve_itp.html</span>

<span class="sd">    https://en.wikipedia.org/wiki/ITP_method</span>

<span class="sd">    ! It is assumed that f(a) &lt; 0 and f(b) &gt; 0, otherwise unexpected results may occur.</span>

<span class="sd">    The ITP method has tuning parameters. This implementation hardwires k2 to 2.0, both because it avoids an expensive floating point exponentiation,</span>
<span class="sd">    and because this value has been tested to work well with curve fitting problems.</span>

<span class="sd">    The n0 parameter controls the relative impact of the bisection and secant components.</span>
<span class="sd">    When it is 0, the number of iterations is guaranteed to be no more than the number required by bisection</span>
<span class="sd">    (thus, this method is strictly superior to bisection). However, when the function is smooth,</span>
<span class="sd">    a value of 1 gives the secant method more of a chance to engage, so the average number of iterations is likely lower,</span>
<span class="sd">    though there can be one more iteration than bisection in the worst case.</span>

<span class="sd">    The k1 parameter is harder to characterize, and interested users are referred to the paper,</span>
<span class="sd">    as well as encouraged to do empirical testing. To match the the paper, a value of 0.2 / (b - a) is suggested,</span>
<span class="sd">    and this is confirmed to give good results. When the function is monotonic,</span>
<span class="sd">    the returned result is guaranteed to be within epsilon of the zero crossing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y_a</span><span class="p">,</span> <span class="n">y_b</span><span class="p">,</span> <span class="n">x_wid</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">n_max</span> <span class="o">=</span> <span class="n">n_0</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">x_wid</span> <span class="o">/</span> <span class="n">eps_2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">j_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Calculating Parameters</span>
        <span class="k">if</span> <span class="n">x_wid</span> <span class="o">&lt;</span> <span class="n">eps_2</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">x_half</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">eps_2</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">**</span> <span class="p">(</span><span class="n">n_max</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_wid</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">k_1</span> <span class="o">*</span> <span class="n">x_wid</span><span class="o">**</span><span class="n">k_2</span>
        <span class="c1"># Interpolation</span>
        <span class="n">x_f</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_b</span> <span class="o">*</span> <span class="n">a</span> <span class="o">-</span> <span class="n">y_a</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y_b</span> <span class="o">-</span> <span class="n">y_a</span><span class="p">)</span>
        <span class="c1"># Truncation</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">x_half</span> <span class="o">-</span> <span class="n">x_f</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">x_half</span> <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="k">else</span> <span class="n">x_f</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">delta</span>
        <span class="c1"># Projection</span>
        <span class="n">x_ITP</span> <span class="o">=</span> <span class="n">x_t</span> <span class="k">if</span> <span class="p">(</span><span class="n">rho</span> <span class="o">&gt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_t</span> <span class="o">-</span> <span class="n">x_half</span><span class="p">))</span> <span class="k">else</span> <span class="n">x_half</span> <span class="o">-</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">rho</span>
        <span class="c1"># Updating interval</span>
        <span class="n">y_ITP</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x_ITP</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y_ITP</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">y_b</span> <span class="o">=</span> <span class="n">x_ITP</span><span class="p">,</span> <span class="n">y_ITP</span>
        <span class="k">elif</span> <span class="n">y_ITP</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">y_a</span> <span class="o">=</span> <span class="n">x_ITP</span><span class="p">,</span> <span class="n">y_ITP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x_ITP</span>
        <span class="n">x_wid</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024-, Tuoyuan Cheng, Kan Chen
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=f5768dfe"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>